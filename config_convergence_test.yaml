# =============================================================================
# SGFA CONVERGENCE TEST CONFIGURATION - Testing Convergence Fixes
#
# This config tests the fixed model with convergence improvements:
# FIXES IMPLEMENTED:
#   - Fix #1: Data-dependent global scale tau_0
#   - Fix #2: Proper slab regularization
#   - Fix #3: Non-centered parameterization
#   - Fix #4: Within-view standardization (preprocessing)
#   - Fix #5: Enhanced MCMC settings (target_accept_prob, max_tree_depth)
#
# CONVERGENCE TARGETS:
#   - R-hat < 1.01 for all parameters
#   - tau in [0.01, 0.05] (centered ~0.0215)
#   - c in [1, 3] (centered ~2)
#   - Divergence rate < 1%
#   - ESS > 400
#
# Expected runtime: ~15-30 minutes (moderate sampling for proper convergence check)
# Baseline comparison: R-hat was 12.6 (catastrophic) -> target < 1.01
# =============================================================================

# Data Configuration - MUST MATCH BASELINE EXACTLY
data:
  data_dir: "./qMAP-PD_data"
  clinical_file: "data_clinical/pd_motor_gfa_data.tsv"
  volume_dir: "volume_matrices"

  # ROI selection: Will load all volume files found in volume_matrices/
  # Baseline used: volume_sn_voxels.tsv (SN ROI only)
  # To match baseline, ensure only SN file is present or specified via volume_files
  imaging_as_single_view: true

# Experiment Configuration
experiments:
  base_output_dir: "./results"
  save_intermediate: true
  generate_plots: true
  max_parallel_jobs: 1

# Model Configuration - USING FIXED MODEL
model:
  model_type: "sparse_gfa_fixed"    # USING FIXED MODEL WITH CONVERGENCE FIXES
  K: 2                               # Same as baseline for comparison

  # MCMC Parameters - Increased for better convergence
  num_samples: 2000                  # Moderate for testing
  num_warmup: 1000                   # Warmup samples
  num_chains: 4                      # Full chains for R-hat calculation

  # Sparsity Parameters (same as baseline)
  percW: 33.0
  sparsity_lambda: 0.3

  # Regularized horseshoe settings
  reghsZ: true
  slab_df: 4.0
  slab_scale: 2.0

  # Reproducibility
  random_seed: 42

# Preprocessing Configuration - FIX #4: Within-view standardization
# Note: Within-view standardization is enabled by default in the preprocessing pipeline
preprocessing:
  strategy: "standard"
  enable_advanced_preprocessing: true
  imputation_strategy: "median"
  feature_selection_method: "none"
  variance_threshold: 0.01
  missing_threshold: 0.8
  roi_based_selection: true
  drop_confounds_from_clinical: true

# Monitoring Configuration
monitoring:
  checkpoint_dir: "./results/convergence_test_checkpoints"
  log_level: "INFO"
  save_checkpoints: true
  checkpoint_interval: 100

# Experiments to run - Focus on factor stability for convergence diagnostics
run_experiments:
  - factor_stability

# Factor Stability Configuration - This will generate convergence diagnostics
factor_stability:
  K: 2                                # Number of latent factors (matches model.K)
  num_chains: 4                       # Number of independent chains (matches model.num_chains)
  num_samples: 2000                   # MCMC samples per chain (matches model.num_samples)
  num_warmup: 1000                    # MCMC warmup samples (matches model.num_warmup)
  chain_method: 'parallel'            # Chain execution: 'parallel', 'sequential', or 'vectorized'

  # Factor matching parameters (Ferreira et al. 2024)
  cosine_threshold: 0.8               # Minimum cosine similarity for matching
  min_match_rate: 0.5                 # Minimum fraction of chains

  # Effective factor counting parameters
  sparsity_threshold: 0.01            # Minimum loading magnitude to be non-zero
  min_nonzero_pct: 0.05               # Minimum fraction of non-zero loadings

  # MCMC sampler parameters - Enhanced for convergence testing
  target_accept_prob: 0.95            # Increased from 0.8 for Fix #5
  max_tree_depth: 12                  # Increased from 13 for Fix #5
  dense_mass: false                   # Use diagonal mass matrix for memory efficiency
